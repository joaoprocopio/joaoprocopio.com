#!/usr/bin/env -S npx tsx

// ./src/constants/typography/script.ts
import fs from "node:fs"
import path from "node:path"
import postcss from "postcss"
import { VARIANT_SIZING } from "./sizing"
import { TRACKING } from "./tracking"
import type { TBreakpoint, TVariant } from "~/constants/typography/types"

const kebabCaseUtil = (str: string) =>
  str.replace(/([a-z])(?=[A-Z\d])/g, "$1-").toLowerCase()

const appendTextVariables = (
  node: postcss.Container,
  variant: string,
  fontSize: number,
  lineHeight: number,
  letterSpacing: number,
) => {
  node.append({
    prop: `--text-${variant}`,
    value: `${fontSize}rem`,
  })
  node.append({
    prop: `--text-${variant}--line-height`,
    value: `${lineHeight}rem`,
  })
  node.append({
    prop: `--text-${variant}--letter-spacing`,
    value: `${letterSpacing}px`,
  })
}

const cssRoot = postcss.root({
  nodes: [
    postcss.comment({
      text: "Please do not edit this file.",
    }),
  ],
})

const atThemeRule = postcss.atRule({
  name: "theme",
})

const atComponentsLayerRule = postcss.atRule({
  name: "layer",
  params: "components",
})

const atBreakpointRule: Record<Exclude<TBreakpoint, "sm">, postcss.AtRule> = {
  md: postcss.atRule({
    name: "media",
    params: `(width >= theme(--breakpoint-md))`,
    nodes: [postcss.rule({ selector: ":root" })],
  }),
  lg: postcss.atRule({
    name: "media",
    params: `(width >= theme(--breakpoint-lg))`,
    nodes: [postcss.rule({ selector: ":root" })],
  }),
}

for (const variant in VARIANT_SIZING) {
  const casedVariant = kebabCaseUtil(variant)
  const breakpointSizing = VARIANT_SIZING[variant as TVariant]

  for (const breakpoint in breakpointSizing) {
    const sizing = breakpointSizing[breakpoint as TBreakpoint]
    const fontSize = sizing.size
    const lineHeight = sizing.leading
    const letterSpacing = TRACKING[(fontSize * 16) as keyof typeof TRACKING]

    if (breakpoint === "sm") {
      appendTextVariables(
        atThemeRule,
        casedVariant,
        fontSize,
        lineHeight,
        letterSpacing,
      )
    } else {
      appendTextVariables(
        atBreakpointRule[breakpoint as Exclude<TBreakpoint, "sm">]!.nodes!.at(
          0,
        ) as postcss.Container,
        casedVariant,
        fontSize,
        lineHeight,
        letterSpacing,
      )
    }
  }
}

atComponentsLayerRule.append(atBreakpointRule.md)
atComponentsLayerRule.append(atBreakpointRule.lg)

cssRoot.append(atThemeRule)
cssRoot.append(atComponentsLayerRule)

const cssPath = path.join(import.meta.dirname, "typography.css")

fs.writeFileSync(cssPath, cssRoot.toString())
